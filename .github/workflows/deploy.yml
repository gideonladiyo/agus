name: Deploy Agus Bot to GCP VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Ensure target dir exists & sync repo via rsync
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
        run: |
          TARGET_DIR="/home/${SERVER_USER}/agus"
          # create dir on remote if not exists
          ssh -o StrictHostKeyChecking=no -p ${SERVER_PORT:-22} ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${TARGET_DIR}"
          # sync repo files to remote (exclude .git)
          rsync -avz --delete --exclude '.git' -e "ssh -p ${SERVER_PORT:-22}" ./ ${SERVER_USER}@${SERVER_HOST}:${TARGET_DIR}/

      - name: Create .env on remote (from secrets)
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          # tambahkan secret lain jika perlu, mis: DB_URL, OTHER_KEY
        run: |
          TARGET_DIR="/home/${SERVER_USER}/agus"
          # create .env remotely safely
          ssh -o StrictHostKeyChecking=no -p ${SERVER_PORT:-22} ${SERVER_USER}@${SERVER_HOST} << EOF
            TARGET_DIR="/home/${SERVER_USER}/agus"
            echo "DISCORD_TOKEN=${DISCORD_TOKEN}" > \$TARGET_DIR/.env
            chmod 600 \$TARGET_DIR/.env
          EOF

      - name: Build image & restart container on remote
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
        run: |
          TARGET_DIR="/home/${SERVER_USER}/agus"
          ssh -o StrictHostKeyChecking=no -p ${SERVER_PORT:-22} ${SERVER_USER}@${SERVER_HOST} bash -lc "
            cd ${TARGET_DIR} || exit 1
            # stop container if running
            if docker ps -q --filter name=agus-bot | grep -q .; then
              docker stop agus-bot || true
              docker rm agus-bot || true
            fi
            # build image
            docker build -t agus-bot:latest .
            # run with restart policy
            docker run -d --name agus-bot --env-file .env -v ${TARGET_DIR}/data:/app/data --restart unless-stopped agus-bot:latest
            # prune old images (optional)
            docker image prune -f
            echo 'DEPLOY_DONE'
          "
