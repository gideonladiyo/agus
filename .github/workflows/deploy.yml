name: CI/CD Pipeline Agus Bot

on:
  push:
    branches:
      - main

jobs:
  deploy-bot:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "âœ… Memastikan direktori proyek tersedia"
            if [ ! -d "/home/gideonladiyo/PaceSorong_DiscordBot" ]; then
                echo "ðŸ“ Direktori belum ada, membuat direktori..."
                mkdir -p "/home/gideonladiyo/agus"
            fi

            cd /home/gideonladiyo/agus

            if [ ! -d ".git" ]; then
                echo "ðŸ”„ Folder belum berisi repo Git, melakukan clone..."
                git clone https://github.com/gideonladiyo/agus.git .
            fi

            echo "ðŸ”‘ Membuat file .env dari secret"
            cat > .env <<EOF
            DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
            EOF

            echo "ðŸ“¥ Menandai folder git sebagai aman"
            git config --global --add safe.directory /home/gideonladiyo/agus

            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin main

            echo "ðŸ³ Mengecek apakah container agus-bot sedang berjalan"
            if [ "$(sudo docker ps -aq -f name=agus-bot)" ]; then
                echo "ðŸ›‘ Menghentikan dan menghapus container lama..."
                docker stop agus
                docker rm agus-bot
            fi

            echo "ðŸ³ Membuild dan menjalankan kontainer Docker"
            docker build -t agus-bot .
            docker run -d \
              --name agus-bot \
              --env-file .env \
              -v /home/gideonladiyo/agus/data:/app/data \
              agus-bot

            echo "ðŸš€ Bot berhasil dideploy